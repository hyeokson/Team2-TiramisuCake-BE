<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VerificationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">com.softeer.backend.fo_domain.user.service</a> &gt; <span class="el_source">VerificationService.java</span></div><h1>VerificationService.java</h1><pre class="source lang-java linenums">package com.softeer.backend.fo_domain.user.service;

import com.softeer.backend.fo_domain.user.constatnt.RedisVerificationPrefix;
import com.softeer.backend.fo_domain.user.constatnt.VerificationProperty;
import com.softeer.backend.fo_domain.user.dto.verification.VerificationCodeResponseDto;
import com.softeer.backend.fo_domain.user.dto.verification.VerificationCodeTestResponseDto;
import com.softeer.backend.fo_domain.user.exception.UserException;
import com.softeer.backend.fo_domain.user.properties.SmsProperties;
import com.softeer.backend.global.common.code.status.ErrorStatus;
import com.softeer.backend.global.util.RandomCodeUtil;
import com.softeer.backend.global.util.StringRedisUtil;
import lombok.extern.slf4j.Slf4j;
import net.nurigo.sdk.NurigoApp;
import net.nurigo.sdk.message.model.Message;
import net.nurigo.sdk.message.request.SingleMessageSendingRequest;
import net.nurigo.sdk.message.response.SingleMessageSentResponse;
import net.nurigo.sdk.message.service.DefaultMessageService;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;

<span class="nc" id="L22">@Slf4j</span>
@Service
public class VerificationService {
    private final DefaultMessageService messageService;
    private final StringRedisUtil stringRedisUtil;
    private final SmsProperties smsProperties;
    private final RandomCodeUtil randomCodeUtil;

    public VerificationService(SmsProperties smsProperties, StringRedisUtil stringRedisUtil,
<span class="nc" id="L31">                               RandomCodeUtil randomCodeUtil) {</span>
<span class="nc" id="L32">        this.messageService = NurigoApp.INSTANCE.initialize(</span>
<span class="nc" id="L33">                smsProperties.getKey(), smsProperties.getSecret(), smsProperties.getUrl());</span>
<span class="nc" id="L34">        this.smsProperties = smsProperties;</span>
<span class="nc" id="L35">        this.stringRedisUtil = stringRedisUtil;</span>
<span class="nc" id="L36">        this.randomCodeUtil = randomCodeUtil;</span>
<span class="nc" id="L37">    }</span>

    /**
     * 1. CoolSms를 사용하여 인증코드를 발급하고 인증 제한시간을 응답에 담아 반환한다.
     * 2. 인증 코드 발급 제한 횟수를 초과하면 내일 다시 인증하라는 응답을 전송한다.
     */
    public VerificationCodeResponseDto sendVerificationCode(String phoneNumber) {

        // 인증코드 발급이 처음이면 redis에 발급 횟수를 저장(유효 기간: 밤 12시 전까지)
<span class="nc bnc" id="L46" title="All 2 branches missed.">        if (!stringRedisUtil.hasKey(RedisVerificationPrefix.VERIFICATION_ISSUE_COUNT.getPrefix() + phoneNumber)) {</span>
<span class="nc" id="L47">            stringRedisUtil.setDataExpireAt(RedisVerificationPrefix.VERIFICATION_ISSUE_COUNT.getPrefix() + phoneNumber,</span>
<span class="nc" id="L48">                    String.valueOf(1), LocalDateTime.now().toLocalDate().atStartOfDay().plusDays(1));</span>

        }
        // 인증코드 발급 제한 횟수를 초과하면 예외 발생
        else {
<span class="nc" id="L53">            long issueCount = stringRedisUtil.incrementData(RedisVerificationPrefix.VERIFICATION_ISSUE_COUNT.getPrefix() + phoneNumber);</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">            if (issueCount &gt; VerificationProperty.CODE_ISSUE_ATTEMPTS.getValue()) {</span>
<span class="nc" id="L55">                log.error(&quot;Exceeded the number of code issuance attempts.&quot;);</span>
<span class="nc" id="L56">                throw new UserException(ErrorStatus._AUTH_CODE_ISSUE_LIMIT_EXCEEDED);</span>
            }
        }

        // 인증코드의 인증 횟수 삭제 (초기화 기능)
<span class="nc" id="L61">        stringRedisUtil.deleteData(RedisVerificationPrefix.VERIFICATION_ATTEMPTS.getPrefix() + phoneNumber);</span>

<span class="nc" id="L63">        Message message = new Message();</span>
<span class="nc" id="L64">        message.setFrom(smsProperties.getSenderNumber());</span>
<span class="nc" id="L65">        message.setTo(phoneNumber);</span>

<span class="nc" id="L67">        String verificationCode = randomCodeUtil.generateRandomCode(</span>
<span class="nc" id="L68">                VerificationProperty.CODE_LENGTH.getValue());</span>
<span class="nc" id="L69">        message.setText(&quot;[Hyundai] 본인 확인 인증번호는 (&quot; + verificationCode + &quot;) 입니다.&quot;);</span>

<span class="nc" id="L71">        SingleMessageSentResponse response = this.messageService.sendOne(new SingleMessageSendingRequest(message));</span>
<span class="nc" id="L72">        log.info(&quot;Verification code sent to {} {}&quot;, phoneNumber, response);</span>

        // 인증코드 저장(유효시간 설정)
<span class="nc" id="L75">        stringRedisUtil.setDataExpire(RedisVerificationPrefix.VERIFICATION_CODE.getPrefix() + phoneNumber, verificationCode,</span>
<span class="nc" id="L76">                VerificationProperty.TIME_LIMIT.getValue());</span>

<span class="nc" id="L78">        return VerificationCodeResponseDto.builder()</span>
<span class="nc" id="L79">                .timeLimit(VerificationProperty.TIME_LIMIT.getValue())</span>
<span class="nc" id="L80">                .build();</span>
    }

    public VerificationCodeTestResponseDto sendVerificationCodeTest(String phoneNumber) {

        // 인증코드 발급이 처음이면 redis에 발급 횟수를 저장(유효 기간: 밤 12시 전까지)
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (!stringRedisUtil.hasKey(RedisVerificationPrefix.VERIFICATION_ISSUE_COUNT.getPrefix() + phoneNumber)) {</span>
<span class="nc" id="L87">            stringRedisUtil.setDataExpireAt(RedisVerificationPrefix.VERIFICATION_ISSUE_COUNT.getPrefix() + phoneNumber,</span>
<span class="nc" id="L88">                    String.valueOf(1), LocalDateTime.now().toLocalDate().atStartOfDay().plusDays(1));</span>

        }
        // 인증코드 발급 제한 횟수를 초과하면 예외 발생
        else {
<span class="nc" id="L93">            long issueCount = stringRedisUtil.incrementData(RedisVerificationPrefix.VERIFICATION_ISSUE_COUNT.getPrefix() + phoneNumber);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            if (issueCount &gt; VerificationProperty.CODE_ISSUE_ATTEMPTS.getValue()) {</span>
<span class="nc" id="L95">                log.error(&quot;Exceeded the number of code issuance attempts.&quot;);</span>
<span class="nc" id="L96">                throw new UserException(ErrorStatus._AUTH_CODE_ISSUE_LIMIT_EXCEEDED);</span>
            }
        }

        // 인증코드의 인증 횟수 삭제 (초기화 기능)
<span class="nc" id="L101">        stringRedisUtil.deleteData(RedisVerificationPrefix.VERIFICATION_ATTEMPTS.getPrefix() + phoneNumber);</span>

<span class="nc" id="L103">        String verificationCode = randomCodeUtil.generateRandomCode(</span>
<span class="nc" id="L104">                VerificationProperty.CODE_LENGTH.getValue());</span>

        // 인증코드 저장(유효시간 설정)
<span class="nc" id="L107">        stringRedisUtil.setDataExpire(RedisVerificationPrefix.VERIFICATION_CODE.getPrefix() + phoneNumber, verificationCode,</span>
<span class="nc" id="L108">                VerificationProperty.TIME_LIMIT.getValue());</span>

<span class="nc" id="L110">        return VerificationCodeTestResponseDto.builder()</span>
<span class="nc" id="L111">                .verificationCode(verificationCode)</span>
<span class="nc" id="L112">                .timeLimit(VerificationProperty.TIME_LIMIT.getValue())</span>
<span class="nc" id="L113">                .build();</span>
    }


    /**
     * 1. 인증 코드를 검증하여 Redis에 있는 인증코도와 같은지를 검사한다.
     * 2. 제한시간이 지났거나 인증코드 불일치, 혹은 인증 제한 횟수를 초과한 경우 예외를 던진다.
     */
    public void confirmVerificationCode(String phoneNumber, String verificationCode) {

        // 인증코드의 인증 제한 횟수를 초과하면 예외 발생
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (stringRedisUtil.hasKey(RedisVerificationPrefix.VERIFICATION_ATTEMPTS.getPrefix() + phoneNumber)) {</span>
<span class="nc" id="L125">            long attemptCount = stringRedisUtil.incrementData(RedisVerificationPrefix.VERIFICATION_ATTEMPTS.getPrefix() + phoneNumber);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (attemptCount &gt; VerificationProperty.MAX_ATTEMPTS.getValue()) {</span>
<span class="nc" id="L127">                log.error(&quot;Verification code attempts exceeded.&quot;);</span>
<span class="nc" id="L128">                throw new UserException(ErrorStatus._AUTH_CODE_ATTEMPTS_EXCEEDED);</span>
            }
<span class="nc" id="L130">        }</span>
        // 인증코드의 인증 횟수 설정(유효 기간: 밤 12시 전까지)
        else {
<span class="nc" id="L133">            stringRedisUtil.setDataExpireAt(RedisVerificationPrefix.VERIFICATION_ATTEMPTS.getPrefix() + phoneNumber,</span>
<span class="nc" id="L134">                    String.valueOf(1), LocalDateTime.now().toLocalDate().atStartOfDay().plusDays(1));</span>
        }

<span class="nc" id="L137">        String originalVerificationCode = stringRedisUtil.getData(RedisVerificationPrefix.VERIFICATION_CODE.getPrefix() + phoneNumber);</span>

<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (originalVerificationCode == null) {</span>
<span class="nc" id="L140">            log.error(&quot;Verification code has expired.&quot;);</span>
<span class="nc" id="L141">            throw new UserException(ErrorStatus._AUTH_CODE_NOT_EXIST);</span>
        }

<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (!originalVerificationCode.equals(verificationCode)) {</span>
<span class="nc" id="L145">            log.error(&quot;Verification code does not match.&quot;);</span>
<span class="nc" id="L146">            throw new UserException(ErrorStatus._AUTH_CODE_NOT_MATCH);</span>
        }

        // 인증 성공
        // 인증 관련한 모든 데이터를 삭제
<span class="nc" id="L151">        stringRedisUtil.deleteData(RedisVerificationPrefix.VERIFICATION_ISSUE_COUNT.getPrefix() + phoneNumber);</span>
<span class="nc" id="L152">        stringRedisUtil.deleteData(RedisVerificationPrefix.VERIFICATION_ATTEMPTS.getPrefix() + phoneNumber);</span>
<span class="nc" id="L153">        stringRedisUtil.deleteData(RedisVerificationPrefix.VERIFICATION_CODE.getPrefix() + phoneNumber);</span>


<span class="nc" id="L156">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>