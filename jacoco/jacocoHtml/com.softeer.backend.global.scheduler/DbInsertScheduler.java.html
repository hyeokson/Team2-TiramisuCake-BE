<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DbInsertScheduler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">com.softeer.backend.global.scheduler</a> &gt; <span class="el_source">DbInsertScheduler.java</span></div><h1>DbInsertScheduler.java</h1><pre class="source lang-java linenums">package com.softeer.backend.global.scheduler;

import com.softeer.backend.bo_domain.eventparticipation.domain.EventParticipation;
import com.softeer.backend.bo_domain.eventparticipation.repository.EventParticipationRepository;
import com.softeer.backend.fo_domain.draw.domain.Draw;
import com.softeer.backend.fo_domain.draw.repository.DrawRepository;
import com.softeer.backend.fo_domain.draw.service.DrawSettingManager;
import com.softeer.backend.fo_domain.fcfs.domain.Fcfs;
import com.softeer.backend.fo_domain.fcfs.repository.FcfsRepository;
import com.softeer.backend.fo_domain.fcfs.service.FcfsSettingManager;
import com.softeer.backend.fo_domain.user.domain.User;
import com.softeer.backend.fo_domain.user.exception.UserException;
import com.softeer.backend.fo_domain.user.repository.UserRepository;
import com.softeer.backend.global.common.code.status.ErrorStatus;
import com.softeer.backend.global.common.constant.RedisKeyPrefix;
import com.softeer.backend.global.util.DrawRedisUtil;
import com.softeer.backend.global.util.EventLockRedisUtil;
import com.softeer.backend.global.util.FcfsRedisUtil;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler;
import org.springframework.scheduling.support.CronTrigger;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.ScheduledFuture;

<span class="nc" id="L33">@Slf4j</span>
@Component
@RequiredArgsConstructor
public class DbInsertScheduler {

    private final ThreadPoolTaskScheduler taskScheduler;
    private final EventLockRedisUtil eventLockRedisUtil;
    private final FcfsRedisUtil fcfsRedisUtil;
    private final DrawRedisUtil drawRedisUtil;
    private final FcfsSettingManager fcfsSettingManager;
    private final DrawSettingManager drawSettingManager;
    private final EventParticipationRepository eventParticipationRepository;
    private final UserRepository userRepository;
    private final FcfsRepository fcfsRepository;
    private final DrawRepository drawRepository;


    private ScheduledFuture&lt;?&gt; scheduledFuture;

    @PostConstruct
    public void init() {
<span class="nc" id="L54">        scheduleTask();</span>

<span class="nc" id="L56">    }</span>

    public void scheduleTask() {
<span class="nc" id="L59">        scheduledFuture = taskScheduler.schedule(this::insertData, new CronTrigger(&quot;0 0 2 * * *&quot;));</span>
<span class="nc" id="L60">    }</span>

    @Transactional
    protected void insertData() {
<span class="nc" id="L64">        LocalDate now = LocalDate.now();</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (now.isBefore(drawSettingManager.getStartDate().plusDays(1)))</span>
<span class="nc" id="L66">            return;</span>

<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (now.isAfter(drawSettingManager.getEndDate().plusDays(1)))</span>
<span class="nc" id="L69">            stopScheduler();</span>

<span class="nc" id="L71">        int totalVisitorsCount = eventLockRedisUtil.getData(RedisKeyPrefix.TOTAL_VISITORS_COUNT_PREFIX.getPrefix());</span>
<span class="nc" id="L72">        eventLockRedisUtil.deleteData(RedisKeyPrefix.TOTAL_VISITORS_COUNT_PREFIX.getPrefix());</span>

<span class="nc" id="L74">        int fcfsParticipantCount = 0;</span>

<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (fcfsSettingManager.getRoundForScheduler(now) != -1) {</span>
<span class="nc" id="L77">            fcfsSettingManager.setFcfsClosed(false);</span>

<span class="nc" id="L79">            int round = fcfsSettingManager.getRoundForScheduler(now);</span>

<span class="nc" id="L81">            Map&lt;String, Integer&gt; participantIds = fcfsRedisUtil.getHashEntries(RedisKeyPrefix.FCFS_CODE_USERID_PREFIX.getPrefix() + round);</span>
<span class="nc" id="L82">            participantIds.forEach((code, userId) -&gt; {</span>
<span class="nc" id="L83">                User user = userRepository.findById(userId)</span>
<span class="nc" id="L84">                        .orElseThrow(() -&gt; {</span>
<span class="nc" id="L85">                            log.error(&quot;user not found in saveFcfsWinners method.&quot;);</span>
<span class="nc" id="L86">                            return new UserException(ErrorStatus._NOT_FOUND);</span>
                        });

<span class="nc" id="L89">                Fcfs fcfs = Fcfs.builder()</span>
<span class="nc" id="L90">                        .user(user)</span>
<span class="nc" id="L91">                        .round(round)</span>
<span class="nc" id="L92">                        .code(code)</span>
<span class="nc" id="L93">                        .build();</span>
<span class="nc" id="L94">                fcfsRepository.save(fcfs);</span>
<span class="nc" id="L95">            });</span>

<span class="nc" id="L97">            fcfsParticipantCount += fcfsRedisUtil.getValue(RedisKeyPrefix.FCFS_PARTICIPANT_COUNT_PREFIX.getPrefix() + round);</span>

<span class="nc" id="L99">            fcfsRedisUtil.clearValue(RedisKeyPrefix.FCFS_PARTICIPANT_COUNT_PREFIX.getPrefix() + round);</span>
<span class="nc" id="L100">            fcfsRedisUtil.clearIntegerSet(RedisKeyPrefix.FCFS_USERID_PREFIX.getPrefix() + round);</span>
<span class="nc" id="L101">            fcfsRedisUtil.clearStringSet(RedisKeyPrefix.FCFS_CODE_PREFIX.getPrefix() + round);</span>
<span class="nc" id="L102">            fcfsRedisUtil.clearHash(RedisKeyPrefix.FCFS_CODE_USERID_PREFIX.getPrefix() + round);</span>
        }

        // drawParticipantCount에 추첨 이벤트 참가자 수 할당하기
<span class="nc" id="L106">        int drawParticipantCount = drawRedisUtil.getDrawParticipantCount();</span>
        // redis에서 추첨 참가자 수 삭제
<span class="nc" id="L108">        drawRedisUtil.deleteDrawParticipantCount();</span>

        // 추첨 당첨자 DB에 insert
        String drawWinnerKey;
<span class="nc bnc" id="L112" title="All 2 branches missed.">        for (int ranking = 1; ranking &lt; 4; ranking++) {</span>
<span class="nc" id="L113">            drawWinnerKey = RedisKeyPrefix.DRAW_WINNER_LIST_PREFIX.getPrefix() + ranking;</span>
<span class="nc" id="L114">            Set&lt;Integer&gt; winnerSet = drawRedisUtil.getAllDataAsSet(drawWinnerKey);</span>

<span class="nc" id="L116">            LocalDate winningDate = LocalDate.now().minusDays(1);</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">            for (Integer userId : winnerSet) {</span>
<span class="nc" id="L119">                User user = userRepository.findById(userId).orElseThrow(</span>
<span class="nc" id="L120">                        () -&gt; new UserException(ErrorStatus._NOT_FOUND));</span>

<span class="nc" id="L122">                Draw draw = Draw.builder()</span>
<span class="nc" id="L123">                        .user(user)</span>
<span class="nc" id="L124">                        .rank(ranking)</span>
<span class="nc" id="L125">                        .winningDate(winningDate)</span>
<span class="nc" id="L126">                        .build();</span>

<span class="nc" id="L128">                drawRepository.save(draw);</span>
<span class="nc" id="L129">            }</span>
        }

        // redis에서 추첨 당첨자 목록 삭제
<span class="nc bnc" id="L133" title="All 2 branches missed.">        for (int ranking = 1; ranking &lt; 4; ranking++) {</span>
<span class="nc" id="L134">            drawWinnerKey = RedisKeyPrefix.DRAW_WINNER_LIST_PREFIX.getPrefix() + ranking;</span>
<span class="nc" id="L135">            drawRedisUtil.deleteAllSetData(drawWinnerKey);</span>
        }

<span class="nc" id="L138">        eventParticipationRepository.save(EventParticipation.builder()</span>
<span class="nc" id="L139">                .visitorCount(totalVisitorsCount)</span>
<span class="nc" id="L140">                .fcfsParticipantCount(fcfsParticipantCount)</span>
<span class="nc" id="L141">                .drawParticipantCount(drawParticipantCount)</span>
<span class="nc" id="L142">                .eventDate(now.minusDays(1))</span>
<span class="nc" id="L143">                .build());</span>
<span class="nc" id="L144">    }</span>

    /**
     * Scheduler의 작업을 비활성화 시키는 메서드
     */
    public void stopScheduler() {
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (scheduledFuture != null) {</span>
<span class="nc" id="L151">            scheduledFuture.cancel(false);</span>
        }
<span class="nc" id="L153">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>